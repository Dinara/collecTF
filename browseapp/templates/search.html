{% extends "base.html" %}
{% load utils %}

{% block content %}

<div class="container">
  <form id="search_form" method="POST" action="{% url browseapp.search.search %}">
    {% csrf_token %}
    
    <div class="row">
      <h4>Select transcription factor(s)</h4>
      <div id="tf_tree" class="boxed">
      </div>
    </div>
    
    <div class="row">
      <h4>Select species</h4>
      <div id="species_tree" class="boxed"> 
      </div>
    </div>

    <div>
    <div class="row">
      <h4>Select experimental techniques</h4>
      <div class="span3">
	<select name="main_category1" id="cat1" class="category">
	  <option value="binding" selected="selected">Binding</option>
	  <option value="expression">Expression</option>
	  <option value="insilico">In-silico</option>
	</select>
      </div>

      <div class="span1">
	<select name="boolean1" class="span1">
	  <option value="and">and</option>
	  <option value="or" selected="selected">or</option>
	</select>
      </div>

      <div class="span3">
	<select name="main_category2" id="cat2" class="category">
	  <option value="binding">Binding</option>
	  <option value="expression"  selected="selected">Expression</option>
	  <option value="insilico">In-silico</option>
	</select>
      </div>

      <div class="span1">
	<select name="boolean2" class="span1">
	  <option value="and">and</option>
	  <option value="or" selected="selected">or</option>
	</select>
      </div>

      <div class="span3">
	<select name="main_category3" id="cat3" class="category">
	  <option value="binding" >Binding</option>
	  <option value="expression">Expression</option>
	  <option value="insilico" selected="selected">In-silico</option>
	</select>
      </div>
    </div>

    <div class="row">
      <div class="span3">
	<div  class="cat1 binding boxed" data-tree-input-name="cat_input_1" style="display:block;">
	</div>
	<div  class="cat1 expression boxed" data-tree-input-name="cat_input_1" style="display:none;">
	</div>
	<div  class="cat1 insilico boxed" data-tree-input-name="cat_input_1" style="display:none;">
	</div>
      </div>

      <div class="span1">
      </div>

      <div class="span3">
	<div  class="cat2 binding boxed" data-tree-input-name="cat_input_2" style="display:none;"> 
	</div>
	<div  class="cat2 expression boxed" data-tree-input-name="cat_input_2" style="display:block;">
	</div>
	<div  class="cat2 insilico boxed" data-tree-input-name="cat_input_2" style="display:none;">
	</div>

      </div>
      <div class="span1">
      </div>

      <div class="span3">
	<div  class="cat3 binding boxed" data-tree-input-name="cat_input_3" style="display:none;">
	</div>
	<div  class="cat3 expression boxed" data-tree-input-name="cat_input_3" style="display:none;">
	</div>
	<div  class="cat3 insilico boxed" data-tree-input-name="cat_input_3" style="display:block;">
	</div>
      </div>
    </div>
    
    <div class="row">
    <input class="btn btn-primary" type="submit" value="submit" />
    </div>
    </div>
  </form>
</div>

<script>
    var tf_data = {
	'child': [
	    {% for TF_family in TF_families %}
	    {
		'text': '{{ TF_family.name }}',
		'child': [
		    {% for TF in TF_family.tf_set.all %}
		    {
			'text': '{{ TF.name }}',
			'value': '{{ TF.TF_id }}'
		    },
		    {% endfor %}
		]
	    },
	    {% endfor %}
	]
    }

var species_data = {
    'child': [
	{% for phylum in phyla %}
	{
	    'text': '{{ phylum.name }}',
	    'child': [
		{% for class_ in phylum.taxonomy_set.all %}
		{
		    'text': '{{ class_.name }}',
		    'child': [
			{% for order in class_.taxonomy_set.all %}
			{
			    'text': '{{ order.name }}',
			    'child': [
				{% for family in order.taxonomy_set.all %}
				{
				    'text': '{{ family.name }}',
				    {% with genera=family.taxonomy_set.all %}
				    {% if genera %}
				    'child': [
					{% for genus in genera %}
					{
					    'text': '{{ genus.name }}',
					    {% with species_all=genus.taxonomy_set.all %}
					    {% if species_all %}
					    'child': [
						{% for species in species_all %}
						{
						    'text': '{{ species.name }}',
						    'value': '{{ species.pk }}'
						},
						{% endfor %}
					    ]
					    {% else %}
					    'value': '{{ genus.pk }}'
					    {% endif %}
					    {% endwith %}
					},
					{% endfor %}
				    ]
				    {% else %}
				    'value': '{{ family.pk }}'
				    {% endif %}
				    {% endwith %}
				},
				{% endfor %}
			    ]
			},
			{% endfor %}
		    ]
		},
		{% endfor %}
	    ]
	},
	{% endfor %}
    ]
}

var binding_techniques = {
    'child': [
	{% for subcategory in binding_techniques|get_keys %}
	{
	    'text': '{{ subcategory }}',
	    'child': [
		{% for technique in binding_techniques|get_item:subcategory %}
		{
		    'text': '{{ technique.name}}',
		    'value': '{{ technique.technique_id }}',
		},
		{% endfor %}
	    ]
	},
	{% endfor %}
    ]
}

var expression_techniques = {
    'child': [
	{% for subcategory in expression_techniques|get_keys %}
	{
	    'text': '{{ subcategory }}',
	    'child': [
		{% for technique in expression_techniques|get_item:subcategory %}
		{
		    'text': '{{ technique.name}}',
		    'value': '{{ technique.technique_id }}',
		},
		{% endfor %}
	    ]
	},
	{% endfor %}
    ]
}

var insilico_techniques = {
    'child': [
	{% for subcategory in insilico_techniques|get_keys %}
	{
	    'text': '{{ subcategory }}',
	    'child': [
		{% for technique in insilico_techniques|get_item:subcategory %}
		{
		    'text': '{{ technique.name}}',
		    'value': '{{ technique.technique_id }}',
		},
		{% endfor %}
	    ]
	},
	{% endfor %}
    ]
}

$('#tf_tree').tree({
    values: tf_data,
    type: 'checkbox',
    input: {name: 'tf_input'},
});
$('#tf_tree').tree('collapseAll');

$('#species_tree').tree({
    values: species_data,
    type: 'checkbox',
    input: {name: 'species_input'},
});
$('#species_tree').tree('collapseAll');

$('.binding').tree({
    values: binding_techniques,
    type: 'checkbox',
    toggleLI: true,
});

$('.binding').tree('collapseAll');

$('.expression').tree({
    values: expression_techniques,
    type: 'checkbox',
    toggleLI: true,
});

$('.expression').tree('collapseAll');

$('.insilico').tree({
    values: insilico_techniques,
    type: 'checkbox',
    toggleLI: true,
});
$('.insilico').tree('collapseAll');

$('.category').on('change', function() {
    var id = $(this).prop('id');
    var selectValue = $(this).val();
    $('.'+id).css("display", "none");
    $('.'+id+'.'+selectValue).css("display", "block");
});

$('input[type=submit]').on('click', function() {
    var selectValue1 = $('#cat1').val();
    var selectValue2 = $('#cat2').val();
    var selectValue3 = $('#cat3').val();
    $.each($('.cat1'), function() {
	if (! $(this).hasClass(selectValue1) )
	    $(this).tree('unselectAll');
    });
    $.each($('.cat2'), function() {
	if (! $(this).hasClass(selectValue2) )
	    $(this).tree('unselectAll');
    });
    $.each($('.cat3'), function() {
	if (! $(this).hasClass(selectValue3) )
	    $(this).tree('unselectAll');
    });
})

</script>

{% endblock %}
