
{% extends "motif_compare_base.html" %}

{% block form %}
{% load webdesign %}

<div class="boxed">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#motif_based" data-toggle="tab">Motif-based similarity</a></li>
    <li><a href="#site_based" data-toggle="tab" onclick="motifSimilarityAJAX('site_based'); return false;">Site-based similarity</a></li>
    <li><a href="#compared_motifs" data-toggle="tab">Compared motifs</a></li>
  </ul>
  
  <div class="tab-content">
    <!-- MOTIF-BASED SIMILARITY -->
    <div class="tab-pane active" id="motif_based">
      <div class="row-fluid">
        <!-- motif-similarity column A -->
        <div class="span6">
          <img src=""
               class="weblogo_img"
               site_data={% for site in motif_a.ensemble_report.aligned_sites %}{{ site }}{% if not forloop.last %},{% endif %}{% endfor %}>
        </div>
        <!-- -similarity column B -->
        <div class="span6">
          <img src=""
               class="weblogo_img"
               site_data={% for site in motif_b.ensemble_report.aligned_sites %}{{ site }}{% if not forloop.last %},{% endif %}{% endfor %}>
        </div>
      </div>
      <hr />
      <div class="tabbable">
        <div class="tabs-left">
          <ul class="nav nav-tabs">
            <li class="active"> <a href="#PCC" data-toggle="tab" onclick="motifSimilarityAJAX('PCC'); return false;">
                Pearson Correlation Coefficient</a></li>
            <li><a href="#ALLR" data-toggle="tab" onclick="motifSimilarityAJAX('ALLR'); return false;">
                Average Log Likelihood Ratio</a></li>
            <li><a href="#KL" data-toggle="tab" onclick="motifSimilarityAJAX('KL'); return false;">
                Kullback-Leibler Divergence</a></li>
            <li><a href="#ED" data-toggle="tab" onclick=" motifSimilarityAJAX('ED'); return false;">
                Euclidean Distance</a></li>
          </ul>
        </div>
        <div class="tab-content">
          <!-- Levenstein distance -->
          <div class="tab-pane active" id="PCC"></div>

          <div class="tab-pane" id="ALLR"></div>

          <div class="tab-pane" id="KL"></div>

          <div class="tab-pane" id="ED"></div>

          <div class="tab-pane" id="motif-based-unaligned">Sites here</div>
          
          <div class="tab-pane" id="motif-based-aligned">Aligned sites here</div>

        </div>
      </div>
    </div>
    <!-- SITE-BASED SIMILARITY -->
    <div class="tab-pane active" id="site_based"></div>

    <!-- COMPARED MOTIFS -->
    <div class="tab-pane" id="compared_motifs">
      <div class="row-fluid">
        <div class="span6">
          <table class="table table-striped table-bordered">
            <thead><th colspan="3">First motif</th></thead>
            <thead>
              <th>TF</th>
              <th>Species</th>
              <th>Report</th>
            </thead>
            <tbody>
              {% for report in motif_a_reports %}
              <tr>
                <td>{{ report.TF_name }}</td>
                <td>{{ report.species_name }}</td>
                {% with form_id=report.TF_name|slugify|add:'_'|add:report.species_name|slugify %}
	            <td><a href="#" onclick="$('#{{ form_id }}').submit();">view</a>
	              <form action="{% url browseapp.view_results.view_results %}" method="post" style="display:inline;" id={{ form_id }}>{% csrf_token %}
	                <input type="hidden" name="motif_csi_list" value="{% for csi_pk in report.csi_list %}{{ csi_pk }}{% if not forloop.last %},{% endif %}{% endfor %}"/>
	                <input type="hidden" name="non_motif_csi_list" value="{% for ncsi_pk in report.non_motif_csi_list %}{{ ncsi_pk }}{% if not forloop.last %},{% endif %}{% endfor %}"/>
	              </form>
	            </td>
	            {% endwith %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="span6">
          <table class="table table-striped table-bordered">
            <thead><th colspan="3">Second motif</th></thead>
            <thead>
              <th>TF</th>
              <th>Species</th>
              <th>Report</th>
            </thead>
            <tbody>
              {% for report in motif_b_reports %}
              <tr>
                <td>{{ report.TF_name }}</td>
                <td>{{ report.species_name }}</td>

                {% with form_id=report.TF_name|slugify|add:'_'|add:report.species_name|slugify %}
	            <td><a href="#" onclick="$('#{{ form_id }}').submit();">view</a>
	              <form action="{% url browseapp.view_results.view_results %}" method="post" style="display:inline;" id={{ form_id }}>{% csrf_token %}
	                <input type="hidden" name="motif_csi_list" value="{% for csi_pk in report.csi_list %}{{ csi_pk }}{% if not forloop.last %},{% endif %}{% endfor %}"/>
	                <input type="hidden" name="non_motif_csi_list" value="{% for ncsi_pk in report.non_motif_csi_list %}{{ ncsi_pk }}{% if not forloop.last %},{% endif %}{% endfor %}"/>
	              </form>
	            </td>
	            {% endwith %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div>
  <form action="" method="post">{% csrf_token %}
    {% include "motif_compare_wizard_navigate.html" %}
  </form>
</div>


{% endblock %}

{% block javascript %}

<script>

function motifSimilarityAJAX(el) {
    // request motif similarity for two motifs
    var elDOM = $('#'+el);
    // if already done, dont make that request again.
    if (!elDOM.is(':empty')) {return false;}
    elDOM.parent().parent().block({message: 'Loading.<br/><i class="icon-spin icon-large icon-spinner"> </i>'});
    $.ajax({
        type: "POST",
        url: "{% url motif_sim_measure %}",
        data: {
            fun: el,
            sites_a: "{% for site in motif_a.ensemble_report.aligned_sites %}{{ site }}{% if not forloop.last %},{% endif %}{% endfor %}",
            sites_b: "{% for site in motif_b.ensemble_report.aligned_sites %}{{ site }}{% if not forloop.last %},{% endif %}{% endfor %}",
            unaligned_sites_a: "{% for meta_site in motif_a.ensemble_report.meta_sites %}{{ meta_site.0.site_instance.seq }}{% if not forloop.last %},{% endif %}{% endfor %}",
            unaligned_sites_b: "{% for meta_site in motif_b.ensemble_report.meta_sites %}{{ meta_site.0.site_instance.seq }}{% if not forloop.last %},{% endif %}{% endfor %}",
            csrfmiddlewaretoken: '{{csrf_token}}'
        },
        success: function(data) {
            elDOM.parent().parent().unblock();
            elDOM.append(data);
            // render MathJax
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            // render motif alignments
            if (el != 'levenstein') {
                elDOM.find('.weblogo_img').each(function() {weblogo(this);});
            }
        },
    });
}

function weblogo(el) {
    var img = $(el);
    img.parent().block();
    var site_data = $(el).attr('site_data');
    $.ajax({
        type: "POST",
        url: "{% url baseapp.views.get_weblogo %}",
        data: {
            sites: site_data,
            csrfmiddlewaretoken:'{{csrf_token}}'
        },
        success: function(data) {
            img.attr('src', data);
            img.parent().unblock();
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) { 
        }
    });
}

$(document).ready(function() {
    $('.weblogo_img').each(function() {
        weblogo(this);
    });

    motifSimilarityAJAX('PCC');
});

</script>

{% endblock %}
